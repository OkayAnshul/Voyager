# Voyager Location Timeline App - Context

## ğŸ¯ CURRENT MISSION: Clean Up & Ship v1

**Active Plan:** `/home/anshul/.claude/plans/mossy-meandering-salamander.md`
**Status:** Planning Complete â†’ Ready for Implementation
**Progress Tracker:** See "IMPLEMENTATION STATUS" section in plan file (auto-updates after each session)

### ğŸ“‹ Session Workflow (IMPORTANT!)

**At START of each session:**
1. Read plan file status section (first 50 lines)
2. Identify what was completed last session
3. Pick next unchecked task to work on

**At END of each session:**
1. Update plan file checkboxes: `- [ ]` â†’ `- [x]` for completed tasks
2. Update "Last Updated" date
3. Update "Current Phase" if phase changed
4. Update "Overall Progress" counter (e.g., "1/4 phases complete")
5. Update Quick Status Summary metrics

**Example Update:**
```bash
# After completing task 1.1:
- [x] 1.1: Create OverpassApiService.kt (~200 lines)
# Update header:
**Last Updated:** 2025-12-03
**Current Phase:** Phase 1 - Task 1/5 complete
**Files Created:** 1/11
```

---

## ğŸ“– Quick Context (Read This First!)

### What We're Doing
Transform Voyager from **prototype with 81K+ UI lines** â†’ **shippable v1 with clean code**

**Key Goals:**
1. **Real POI names** - "Starbucks" not "Restaurant" (OSM Overpass + Nominatim)
2. **Clean timeline** - Show time ranges, not "arrived/left" (GPS is imperfect)
3. **Simplified UI** - Glassmorphism design, 2-tier settings (not 3), 2 analytics screens (not 4)
4. **Professional** - Hide debug behind dev mode, -1,000 lines of code

### Critical Findings from Analysis
- âœ… **Architecture is solid** (Clean + MVVM)
- âœ… **Core tracking works** (DBSCAN clustering, visit detection)
- âœ… **Geocoding IS wired** but only uses Nominatim (need Overpass for business names)
- âŒ **No real POI names** - places still generic ("Gym 123")
- âŒ **UI bloated** - 3-tier settings, 16K-line analytics screens, 26K debug code in production
- âŒ **Timeline wording** - Uses "arrived/left" events (TimelineScreen.kt:232-246)

---

## ğŸš€ Implementation Phases (4-6 Weeks)

### Phase 1: POI Resolution (Weeks 1-2) ğŸ”´ CRITICAL
**Goal:** Get real business names ("Starbucks" not "Restaurant")

**Create:**
- `data/api/OverpassApiService.kt` - Query OSM for business names
- `data/api/RateLimiter.kt` - 1 req/sec rate limiting

**Modify:**
- `data/repository/GeocodingRepositoryImpl.kt` - Try Overpass â†’ Nominatim â†’ Category
- `domain/usecase/EnrichPlaceWithDetailsUseCase.kt` - Prioritize business names
- `di/NetworkModule.kt` - Wire Overpass service

**Success:** 70%+ places have real business names

---

### Phase 2: Timeline Redesign (Week 3) ğŸŸ  HIGH
**Goal:** Show time ranges, not "arrived/left" (handle GPS inaccuracy)

**Create:**
- `domain/model/TimelineSegment.kt` - View model for time ranges
- `domain/usecase/GenerateTimelineSegmentsUseCase.kt` - Group visits by time/distance
- `presentation/screen/settings/components/TimelineSettingsSection.kt` - 15/30/60 min grouping

**Modify:**
- `domain/model/UserPreferences.kt` - Add timelineTimeWindowMinutes
- `presentation/screen/timeline/TimelineScreen.kt` - Use TimelineSegmentCard (no "arrived/left")
- `presentation/screen/timeline/TimelineViewModel.kt` - Call GenerateTimelineSegmentsUseCase

**Success:** No "arrived/left" wording, logical grouping, distance between places shown

---

### Phase 3: UI/UX Simplification (Weeks 4-5) ğŸŸ¡ MEDIUM
**Goal:** Glassmorphism design, consolidated features

**Create:**
- `presentation/theme/GlassmorphismComponents.kt` - GlassCard, GlassButton, GlassChip
- `presentation/screen/settings/AdvancedSettingsScreen.kt` - Merge Enhanced + Expert
- `presentation/screen/settings/DeveloperModeManager.kt` - Tap version 7x toggle
- `presentation/screen/analytics/StatisticsScreen.kt` - Merge Weekly + Patterns

**Modify:**
- `presentation/screen/settings/SettingsScreen.kt` - Simplify to ~300 lines (from 671)
- `presentation/screen/insights/InsightsScreen.kt` - Enhance with Movement + Social

**Delete:**
- `EnhancedSettingsScreen.kt`, `ExpertSettingsScreen.kt`
- `WeeklyComparisonScreen.kt`, `MovementAnalyticsScreen.kt`, `SocialHealthAnalyticsScreen.kt`
- `PermissionGatewayScreen.kt` (orphaned)
- 6 redundant settings components

**Success:** Settings 3â†’2 tiers, Analytics 4â†’2 screens, glassmorphism applied, debug hidden

---

### Phase 4: Documentation & Cleanup (Week 6) ğŸŸ¢ LOW
**Goal:** Ultimate Guide + organized docs

**Create:**
- `docs/ULTIMATE_GUIDE.md` - Architecture, pipeline, evolution, POI strategy
- `docs/archive/` - Move all old PHASE_*, SESSION_*, *_SUMMARY.md files

**Cleanup:**
- Run Android Lint, add KDoc, format code
- Delete unused ViewModels, components, screens

**Success:** Comprehensive docs, -1,070 net lines of code

---

## ğŸ“‚ Architecture Quick Reference

```
Voyager (Clean Architecture)
â”œâ”€â”€ presentation/          # Jetpack Compose UI
â”‚   â”œâ”€â”€ screen/           # 14 screens (13 active, 1 orphaned)
â”‚   â”œâ”€â”€ theme/            # Material3 + glassmorphism (to create)
â”‚   â””â”€â”€ navigation/       # NavHost
â”œâ”€â”€ domain/               # Business logic
â”‚   â”œâ”€â”€ model/            # Location, Place, Visit, TimelineSegment (new)
â”‚   â”œâ”€â”€ usecase/          # PlaceDetection, EnrichPlace, GenerateTimeline (new)
â”‚   â””â”€â”€ repository/       # Interfaces
â”œâ”€â”€ data/
â”‚   â”œâ”€â”€ api/              # Overpass (new), Nominatim, AndroidGeocoder
â”‚   â”œâ”€â”€ service/          # LocationTrackingService
â”‚   â”œâ”€â”€ processor/        # SmartDataProcessor
â”‚   â”œâ”€â”€ database/         # Room + SQLCipher encrypted
â”‚   â””â”€â”€ repository/       # GeocodingRepo, PlaceRepo, VisitRepo
â””â”€â”€ utils/                # LocationUtils, SecurityUtils
```

**Tech:** Kotlin, Compose, Hilt, Room+SQLCipher, Play Services, OSM

---

## ğŸ”‘ Critical Files by Phase

### Phase 1: POI Resolution
- `EnrichPlaceWithDetailsUseCase.kt` (line 127-168: generateSmartName)
- `GeocodingRepositoryImpl.kt` (line 99-119: getPlaceDetailsForCoordinates)
- `PlaceDetectionUseCases.kt` (line 301: enrichPlaceWithDetailsUseCase call)
- **NOTE:** Geocoding IS integrated, just missing Overpass API

### Phase 2: Timeline
- `TimelineScreen.kt` (line 214-288: TimelineEntryCard - replace with TimelineSegmentCard)
- `TimelineViewModel.kt` (add GenerateTimelineSegmentsUseCase)
- `Visit.kt` (has entryTime/exitTime - keep model, change UI presentation)

### Phase 3: UI Consolidation
- `SettingsScreen.kt` (671 lines â†’ simplify to 300)
- `EnhancedSettingsScreen.kt` + `ExpertSettingsScreen.kt` (merge into AdvancedSettingsScreen.kt)
- `WeeklyComparisonScreen.kt` (merge into StatisticsScreen.kt)
- All screens (apply GlassCard component)

### Phase 4: Docs
- Create `ULTIMATE_GUIDE.md`
- Move 30+ old docs to `docs/archive/`

---

## ğŸ”§ Quick Commands

### Build & Test
```bash
./gradlew assembleDebug
./gradlew installDebug
adb logcat | grep Voyager
```

### Database Check
```bash
adb shell
run-as com.cosmiclaboratory.voyager
cd databases && sqlite3 voyager.db
.schema geocoding_cache  # Should exist but empty
SELECT COUNT(*) FROM places WHERE address IS NOT NULL;
```

### Test POI Resolution (after Phase 1)
```bash
adb logcat | grep "EnrichPlaceUseCase"
# Should see: "Using business name: Starbucks"
```

---

## ğŸ“Š Success Metrics Summary

| Phase | Metric |
|-------|--------|
| **1: POI** | 70%+ real business names, no rate limit violations |
| **2: Timeline** | No "arrived/left" wording, logical grouping, distance shown |
| **3: UI/UX** | Settings 3â†’2 tiers, Analytics 4â†’2 screens, glassmorphism applied |
| **4: Docs** | Ultimate Guide complete, -1,070 net lines |

---

## âš ï¸ Important Notes

### What Already Exists (Don't Rebuild!)
- âœ… GeocodingRepository with cache (30-day TTL)
- âœ… AndroidGeocoder + NominatimGeocodingService
- âœ… EnrichPlaceWithDetailsUseCase (called at PlaceDetectionUseCases:301)
- âœ… Place model has osmSuggestedName, address fields
- âœ… GeocodingCacheEntity in database (exists but underutilized)

**Just add Overpass API and improve name priority!**

### Risk Areas
1. **OSM Overpass rate limiting** â†’ Use aggressive caching + rate limiter
2. **Timeline grouping complexity** â†’ Start simple, test with synthetic data
3. **UI consolidation breaking features** â†’ Incremental refactor, test each screen
4. **Glassmorphism performance** â†’ Use alpha sparingly, test on low-end devices

### Assumptions
1. User will provide glassmorphism reference image for styling
2. OSM Overpass API available (99.9% uptime)
3. Existing geocoding cache reusable (no schema changes)
4. Map screen has limited value (can simplify/remove)
5. Database v1 acceptable for v1 ship

---

## ğŸ’¡ Implementation Tips

1. **Follow the plan** - It's in `/home/anshul/.claude/plans/mossy-meandering-salamander.md`
2. **Start with Phase 1** - POI resolution is critical path (blocks v1)
3. **Test incrementally** - Don't implement entire phase at once
4. **Use existing infra** - Geocoding already works, just enhance it
5. **Log everything** - Add Log.d() for debugging OSM queries

---

## ğŸ‰ Vision: Before â†’ After

### Before (Current Prototype)
```
Timeline:
  âœ“ Arrived at Restaurant - 2:28 PM
  âœ“ Left Restaurant - 4:32 PM
  âœ“ Arrived at Gym 456 - 6:15 PM

Settings: Basic â†’ Enhanced â†’ Expert (3 tiers, confusing)
Analytics: 4 separate screens (16K lines each)
Debug: Visible in production UI
```

### After (Shippable v1)
```
Timeline:
  ğŸ½ï¸ Starbucks Coffee
     2:30 PM - 4:15 PM (1h 45m)
     123 Main St, Springfield
     â†“ Traveled 2.3 km to next

  ğŸ’ª Planet Fitness
     6:15 PM - 7:30 PM (1h 15m)

Settings: Basic â†’ Advanced (2 tiers, clear)
Analytics: Statistics + Insights (2 screens, focused)
Debug: Hidden (tap version 7x to enable)
```

**Net Result:** -1,070 lines, cleaner code, shippable product! ğŸš€

---

## ğŸ“š Full Documentation

**Active Plan:** `/home/anshul/.claude/plans/mossy-meandering-salamander.md` (Complete implementation details)

**Reference Docs:**
- `docs/ARCHITECTURE_GUIDE.md` - Architecture patterns
- `docs/VOYAGER_PROJECT_STATUS.md` - Current state analysis

**To Archive (Phase 4):**
- All `PHASE_*.md`, `SESSION_*.md`, `*_SUMMARY.md` files
- `DETECTION_*`, `ML_UX_*`, `TESTING_*` docs
